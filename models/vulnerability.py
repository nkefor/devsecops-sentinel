"""Vulnerability data model with CIS Benchmark mappings."""
from dataclasses import dataclass, field
from enum import Enum
from typing import Optional, Dict, List


class Severity(Enum):
    """Vulnerability severity levels."""
    CRITICAL = "CRITICAL"
    HIGH = "HIGH"
    MEDIUM = "MEDIUM"
    LOW = "LOW"
    INFO = "INFO"

    @classmethod
    def from_string(cls, value: str) -> 'Severity':
        """Convert string to Severity enum."""
        mapping = {
            'critical': cls.CRITICAL,
            'high': cls.HIGH,
            'medium': cls.MEDIUM,
            'low': cls.LOW,
            'info': cls.INFO,
            'unknown': cls.MEDIUM,
        }
        return mapping.get(value.lower(), cls.MEDIUM)

    @property
    def priority(self) -> int:
        """Return priority for sorting (lower = more urgent)."""
        priorities = {
            Severity.CRITICAL: 1,
            Severity.HIGH: 2,
            Severity.MEDIUM: 3,
            Severity.LOW: 4,
            Severity.INFO: 5,
        }
        return priorities.get(self, 3)


# CIS Benchmark mappings for common security issues
CIS_BENCHMARK_MAP: Dict[str, Dict[str, str]] = {
    # Security Group Issues
    "CKV_AWS_23": {
        "cis_id": "CIS AWS 5.2",
        "title": "Ensure no security groups allow ingress from 0.0.0.0/0 to port 22",
        "soc2": "CC6.1, CC6.6",
        "pci_dss": "1.2.1, 1.3.1"
    },
    "CKV_AWS_24": {
        "cis_id": "CIS AWS 5.3",
        "title": "Ensure no security groups allow ingress from 0.0.0.0/0 to port 3389",
        "soc2": "CC6.1, CC6.6",
        "pci_dss": "1.2.1, 1.3.1"
    },
    "CKV_AWS_25": {
        "cis_id": "CIS AWS 5.4",
        "title": "Ensure no security groups allow ingress from 0.0.0.0/0 to remote server administration ports",
        "soc2": "CC6.1, CC6.6",
        "pci_dss": "1.2.1, 1.3.1"
    },
    # S3 Bucket Issues
    "CKV_AWS_18": {
        "cis_id": "CIS AWS 2.1.1",
        "title": "Ensure S3 bucket access logging is enabled",
        "soc2": "CC7.2",
        "pci_dss": "10.2"
    },
    "CKV_AWS_19": {
        "cis_id": "CIS AWS 2.1.2",
        "title": "Ensure S3 bucket has server-side encryption enabled",
        "soc2": "CC6.1",
        "pci_dss": "3.4"
    },
    "CKV_AWS_20": {
        "cis_id": "CIS AWS 2.1.5",
        "title": "Ensure S3 bucket does not have a public ACL",
        "soc2": "CC6.1",
        "pci_dss": "7.1"
    },
    "CKV_AWS_21": {
        "cis_id": "CIS AWS 2.1.5",
        "title": "Ensure S3 bucket versioning is enabled",
        "soc2": "CC7.4",
        "pci_dss": "10.7"
    },
    "CKV2_AWS_6": {
        "cis_id": "CIS AWS 2.1.5",
        "title": "Ensure S3 bucket has public access blocks",
        "soc2": "CC6.1",
        "pci_dss": "7.1"
    },
    # RDS Issues
    "CKV_AWS_16": {
        "cis_id": "CIS AWS 2.3.1",
        "title": "Ensure RDS database instances are encrypted",
        "soc2": "CC6.1",
        "pci_dss": "3.4"
    },
    "CKV_AWS_17": {
        "cis_id": "CIS AWS 2.3.2",
        "title": "Ensure RDS instance is not publicly accessible",
        "soc2": "CC6.1, CC6.6",
        "pci_dss": "1.3"
    },
    "CKV_AWS_157": {
        "cis_id": "CIS AWS 2.3.3",
        "title": "Ensure RDS database has IAM authentication enabled",
        "soc2": "CC6.1",
        "pci_dss": "8.3"
    },
    # IAM Issues
    "CKV_AWS_40": {
        "cis_id": "CIS AWS 1.16",
        "title": "Ensure IAM policies are attached only to groups or roles",
        "soc2": "CC6.1",
        "pci_dss": "7.1"
    },
    "CKV_AWS_1": {
        "cis_id": "CIS AWS 1.22",
        "title": "Ensure IAM policies do not allow full '*' administrative privileges",
        "soc2": "CC6.1, CC6.3",
        "pci_dss": "7.1, 7.2"
    },
    # Encryption Issues
    "CKV_AWS_7": {
        "cis_id": "CIS AWS 2.8",
        "title": "Ensure rotation for customer created CMKs is enabled",
        "soc2": "CC6.1",
        "pci_dss": "3.6.4"
    },
    # CloudTrail
    "CKV_AWS_35": {
        "cis_id": "CIS AWS 3.1",
        "title": "Ensure CloudTrail is enabled in all regions",
        "soc2": "CC7.2",
        "pci_dss": "10.1"
    },
    # Trivy specific mappings
    "AVD-AWS-0107": {
        "cis_id": "CIS AWS 5.2",
        "title": "Security group allows unrestricted SSH access",
        "soc2": "CC6.1, CC6.6",
        "pci_dss": "1.2.1"
    },
    "AVD-AWS-0102": {
        "cis_id": "CIS AWS 2.1.5",
        "title": "S3 bucket does not have public access blocks",
        "soc2": "CC6.1",
        "pci_dss": "7.1"
    },
}


@dataclass
class Vulnerability:
    """Represents a security vulnerability found in infrastructure code."""

    check_id: str
    check_name: str
    file_path: str
    severity: Severity
    scanner: str  # 'checkov' or 'trivy'

    # Optional fields
    resource: str = ""
    line_start: int = 0
    line_end: int = 0
    guideline: str = ""

    # CIS/Compliance mappings (populated automatically)
    cis_benchmark: str = field(default="", init=False)
    cis_title: str = field(default="", init=False)
    soc2_controls: str = field(default="", init=False)
    pci_dss_controls: str = field(default="", init=False)

    def __post_init__(self):
        """Populate CIS benchmark mappings after initialization."""
        self._populate_compliance_mappings()

    def _populate_compliance_mappings(self):
        """Look up and populate compliance framework mappings."""
        mapping = CIS_BENCHMARK_MAP.get(self.check_id, {})
        self.cis_benchmark = mapping.get("cis_id", "N/A")
        self.cis_title = mapping.get("title", self.check_name)
        self.soc2_controls = mapping.get("soc2", "N/A")
        self.pci_dss_controls = mapping.get("pci_dss", "N/A")

    @property
    def has_compliance_mapping(self) -> bool:
        """Check if this vulnerability has CIS benchmark mapping."""
        return self.cis_benchmark != "N/A"

    def to_dict(self) -> Dict:
        """Convert to dictionary for JSON serialization."""
        return {
            "check_id": self.check_id,
            "check_name": self.check_name,
            "file_path": self.file_path,
            "severity": self.severity.value,
            "scanner": self.scanner,
            "resource": self.resource,
            "line_start": self.line_start,
            "line_end": self.line_end,
            "guideline": self.guideline,
            "cis_benchmark": self.cis_benchmark,
            "cis_title": self.cis_title,
            "soc2_controls": self.soc2_controls,
            "pci_dss_controls": self.pci_dss_controls,
        }

    def __lt__(self, other: 'Vulnerability') -> bool:
        """Compare vulnerabilities by severity for sorting."""
        return self.severity.priority < other.severity.priority


def prioritize_vulnerabilities(vulns: List[Vulnerability]) -> List[Vulnerability]:
    """Sort vulnerabilities by severity (Critical first)."""
    return sorted(vulns)
